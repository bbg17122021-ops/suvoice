<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuy·ªÉn VƒÉn b·∫£n th√†nh Gi·ªçng n√≥i</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style cho n√∫t download */
        .download-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #10b981; /* M√†u xanh ng·ªçc */
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .download-button:hover {
            background-color: #059669;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">üé§ TTS Gemini N√¢ng Cao</h1>
        <p class="text-center text-gray-500 mb-6">Ch·ªçn gi·ªçng n√≥i v√† t·ªëc ƒë·ªô, sau ƒë√≥ nh·∫≠p vƒÉn b·∫£n. B·∫°n c√≥ th·ªÉ t·∫£i audio v·ªÅ sau khi t·∫°o.</p>

        <!-- Khu v·ª±c t√πy ch·ªçn -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Ch·ªçn Gi·ªçng n√≥i -->
            <div>
                <label for="voiceSelector" class="block text-sm font-medium text-gray-700 mb-1">Gi·ªçng N√≥i:</label>
                <select id="voiceSelector" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <!-- Gi·ªçng N·ªØ -->
                    <optgroup label="Gi·ªçng N·ªØ">
                        <option value="Achernar">N·ªØ truy·ªÅn c·∫£m, d·ªãu d√†ng (Achernar)</option>
                        <option value="Sadachbia">N·ªØ vui v·∫ª, s·ªëng ƒë·ªông (Sadachbia)</option>
                        <option value="Erinome">N·ªØ trang tr·ªçng, r√µ r√†ng (Erinome)</option>
                        <option value="Leda">N·ªØ tr·∫ª (Leda)</option>
                        <option value="Umbriel">N·ªØ d·ªÖ t√≠nh (Umbriel)</option>
                    </optgroup>
                    <!-- Gi·ªçng Nam -->
                    <optgroup label="Gi·ªçng Nam">
                        <option value="Puck" selected>Nam tr·∫ª (Puck)</option>
                        <option value="Gacrux">Nam tr·∫ßm ·∫•m, tr∆∞·ªüng th√†nh (Gacrux)</option>
                        <option value="Fenrir">Nam nhi·ªát huy·∫øt, ho·∫°t b√°t (Fenrir)</option>
                        <option value="Kore">Nam tr∆∞·ªüng th√†nh (Kore)</option>
                    </optgroup>
                </select>
            </div>
            
            <!-- ƒêi·ªÅu ch·ªânh T·ªëc ƒë·ªô -->
            <div>
                <label for="speedSelector" class="block text-sm font-medium text-gray-700 mb-1">T·ªëc ƒê·ªô ƒê·ªçc:</label>
                <select id="speedSelector" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="normal" selected>B√¨nh th∆∞·ªùng</option>
                    <option value="slow">Ch·∫≠m</option>
                    <option value="fast">Nhanh</option>
                </select>
            </div>
        </div>

        <!-- Khu v·ª±c nh·∫≠p li·ªáu -->
        <textarea
            id="textInput"
            rows="5"
            class="w-full p-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out resize-none mb-4"
            placeholder="V√≠ d·ª•: C√¥ng ngh·ªá tr√≠ tu·ªá nh√¢n t·∫°o ƒëang thay ƒë·ªïi c√°ch ch√∫ng ta l√†m vi·ªác v√† t∆∞∆°ng t√°c. H√£y nghe th·ª≠ gi·ªçng n√≥i m·ªõi n√†y nh√©.">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ·ª©ng d·ª•ng Chuy·ªÉn vƒÉn b·∫£n th√†nh gi·ªçng n√≥i phi√™n b·∫£n ƒë·∫ßy ƒë·ªß. B·∫°n c√≥ th·ªÉ ch·ªçn b·∫•t k·ª≥ gi·ªçng n√†o trong ch√≠n t√πy ch·ªçn c√≥ s·∫µn, t·ª´ tr·∫ßm ·∫•m ƒë·∫øn vui v·∫ª, v√† ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô ƒë·ªçc theo √Ω mu·ªën c·ªßa m√¨nh.</textarea>

        <!-- N√∫t t·∫°o gi·ªçng n√≥i -->
        <button
            id="generateButton"
            class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="buttonText">T·∫°o Gi·ªçng N√≥i</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>

        <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <div id="resultArea" class="mt-6 p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">K·∫øt Qu·∫£ Audio:</h2>
            <audio id="audioPlayer" controls class="w-full mb-3"></audio>
            <!-- N√∫t T·∫£i Xu·ªëng m·ªõi -->
            <button id="downloadButton" class="download-button w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v7a1 1 0 11-2 0V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                T·∫£i Xu·ªëng Audio (.wav)
            </button>
        </div>

        <!-- Khu v·ª±c th√¥ng b√°o l·ªói/th√¥ng tin -->
        <div id="messageBox" class="mt-4 p-3 rounded-lg text-sm text-center hidden"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Bi·∫øn to√†n c·ª•c t·ª´ m√¥i tr∆∞·ªùng Canvas (B·∫ÆT BU·ªòC S·ª¨ D·ª§NG)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let globalWavBlob = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ Blob cho ch·ª©c nƒÉng t·∫£i xu·ªëng

        // Kh·ªüi t·∫°o Firebase (ch·ªß y·∫øu ƒë·ªÉ ƒë√°p ·ª©ng y√™u c·∫ßu m√¥i tr∆∞·ªùng, kh√¥ng d√πng cho TTS)
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            (async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            })();

        } catch (error) {
            console.error("L·ªói khi kh·ªüi t·∫°o Firebase:", error);
        }

        // ----------------------
        // C√ÅC H√ÄM X·ª¨ L√ù CHUY·ªÇN ƒê·ªîI AUDIO (PCM sang WAV)
        // ----------------------

        /**
         * Chuy·ªÉn ƒë·ªïi Base64 th√†nh ArrayBuffer
         * @param {string} base64 - D·ªØ li·ªáu audio base64
         * @returns {ArrayBuffer}
         */
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        /**
         * Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu PCM 16-bit th√†nh Blob file WAV
         * @param {Int16Array} pcm16 - D·ªØ li·ªáu audio PCM (16-bit signed)
         * @param {number} sampleRate - T·∫ßn s·ªë l·∫•y m·∫´u (v√≠ d·ª•: 24000)
         * @returns {Blob} File Blob WAV
         */
        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bitDepth = 16;
            const numSamples = pcm16.length;

            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);

            // Ghi ti√™u ƒë·ªÅ RIFF (12 bytes)
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true); // T·ªïng k√≠ch th∆∞·ªõc t·ªáp
            writeString(view, 8, 'WAVE');

            // Ghi kh·ªëi 'fmt ' (24 bytes)
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // K√≠ch th∆∞·ªõc c·ªßa kh·ªëi fmt (16)
            view.setUint16(20, 1, true); // ƒê·ªãnh d·∫°ng audio (1 = PCM)
            view.setUint16(22, numChannels, true); // S·ªë l∆∞·ª£ng k√™nh (1)
            view.setUint32(24, sampleRate, true); // T·∫ßn s·ªë l·∫•y m·∫´u
            view.setUint32(28, sampleRate * numChannels * (bitDepth / 8), true); // Byte rate
            view.setUint16(32, numChannels * (bitDepth / 8), true); // Block align
            view.setUint16(34, bitDepth, true); // ƒê·ªô s√¢u bit (16)

            // Ghi kh·ªëi 'data' (8 + data size)
            writeString(view, 36, 'data');
            view.setUint32(40, numSamples * 2, true); // K√≠ch th∆∞·ªõc d·ªØ li·ªáu (samples * 2 bytes/sample)

            // Ghi d·ªØ li·ªáu PCM
            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true); // Ghi d·ªØ li·ªáu 16-bit (little endian)
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        // ----------------------
        // H√ÄM X·ª¨ L√ù GIAO DI·ªÜN, API V√Ä DOWNLOAD
        // ----------------------

        const textInput = document.getElementById('textInput');
        const generateButton = document.getElementById('generateButton');
        const downloadButton = document.getElementById('downloadButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const audioPlayer = document.getElementById('audioPlayer');
        const resultArea = document.getElementById('resultArea');
        const messageBox = document.getElementById('messageBox');
        const voiceSelector = document.getElementById('voiceSelector');
        const speedSelector = document.getElementById('speedSelector');


        /** Hi·ªÉn th·ªã th√¥ng b√°o tr√™n giao di·ªán */
        const showMessage = (text, classes) => {
            messageBox.innerHTML = text; 
            messageBox.className = `mt-4 p-3 rounded-lg text-sm text-center ${classes}`;
            messageBox.style.display = 'block';
        };

        /** ·∫®n th√¥ng b√°o */
        const hideMessage = () => {
            messageBox.style.display = 'none';
        };

        /** Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i loading */
        const setLoading = (isLoading) => {
            generateButton.disabled = isLoading;
            textInput.disabled = isLoading;
            voiceSelector.disabled = isLoading;
            speedSelector.disabled = isLoading;

            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                buttonText.textContent = 'ƒêang t·∫°o...';
                hideMessage();
            } else {
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'T·∫°o Gi·ªçng N√≥i';
            }
        };

        /** X·ª≠ l√Ω ch·ª©c nƒÉng T·∫£i Xu·ªëng */
        const handleDownload = () => {
            if (globalWavBlob) {
                const url = URL.createObjectURL(globalWavBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // T·∫°o t√™n file d·ª±a tr√™n th·ªùi gian hi·ªán t·∫°i
                const now = new Date();
                const filename = `audio_tts_${now.toISOString().replace(/[:.]/g, '-')}.wav`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage(`ƒê√£ t·∫£i xu·ªëng th√†nh c√¥ng file <b>${filename}</b>.`, 'bg-indigo-100 text-indigo-800');
            } else {
                showMessage("Kh√¥ng c√≥ file audio ƒë·ªÉ t·∫£i xu·ªëng. Vui l√≤ng t·∫°o gi·ªçng n√≥i tr∆∞·ªõc.", 'bg-yellow-100 text-yellow-800');
            }
        };

        /** X·ª≠ l√Ω API TTS v·ªõi logic backoff */
        const generateTTS = async (text) => {
            if (!text.trim()) {
                showMessage("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn chuy·ªÉn ƒë·ªïi.", 'bg-yellow-100 text-yellow-800');
                return;
            }

            const selectedVoice = voiceSelector.value;
            const selectedSpeed = speedSelector.value;
            let finalPrompt = text;

            // √Åp d·ª•ng ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô
            if (selectedSpeed === 'slow') {
                finalPrompt = `Say very slowly: ${text}`;
            } else if (selectedSpeed === 'fast') {
                finalPrompt = `Say very quickly: ${text}`;
            }

            setLoading(true);
            hideMessage();
            audioPlayer.src = '';
            resultArea.classList.add('hidden');
            globalWavBlob = null; // Reset Blob c≈©

            const apiKey = ""; 

            // C·∫•u h√¨nh payload
            const payload = {
                contents: [{
                    parts: [{ text: finalPrompt }] 
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: selectedVoice } 
                        }
                    }
                },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const MAX_RETRIES = 3;
            let attempt = 0;
            let response = null;

            while (attempt < MAX_RETRIES) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; 
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                        console.warn(`Throttling (429). Th·ª≠ l·∫°i l·∫ßn ${attempt + 1} sau ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`L·ªói HTTP: ${response.status} - ${await response.text()}`);
                    }
                } catch (error) {
                    console.error(`L·ªói trong l·∫ßn th·ª≠ ${attempt + 1}: `, error);
                }
                attempt++;
            }

            setLoading(false);

            if (!response || !response.ok) {
                showMessage("L·ªñI: Kh√¥ng th·ªÉ t·∫°o gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i sau.", 'bg-red-100 text-red-800');
                return;
            }

            try {
                const result = await response.json();
                const candidate = result?.candidates?.[0];
                const part = candidate?.content?.parts?.find(p => p.inlineData);

                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;

                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);

                    // Chuy·ªÉn PCM sang Blob WAV v√† l∆∞u v√†o bi·∫øn to√†n c·ª•c
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    globalWavBlob = wavBlob; 
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    resultArea.classList.remove('hidden');
                    
                    // X·ª≠ l√Ω t·ª± ƒë·ªông ph√°t (Autoplay)
                    try {
                        const playPromise = audioPlayer.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                showMessage("ƒê√£ t·∫°o v√† ƒëang ph√°t gi·ªçng n√≥i!", 'bg-green-100 text-green-800');
                            }).catch(error => {
                                showMessage("ƒê√£ t·∫°o gi·ªçng n√≥i th√†nh c√¥ng. Vui l√≤ng nh·∫•n n√∫t <b>PLAY (‚ñ∂)</b> ƒë·ªÉ nghe ho·∫∑c <b>T·∫£i Xu·ªëng</b>.", 'bg-yellow-100 text-yellow-800');
                            });
                        }
                    } catch(e) {
                         showMessage("ƒê√£ t·∫°o gi·ªçng n√≥i th√†nh c√¥ng. Vui l√≤ng nh·∫•n n√∫t <b>PLAY (‚ñ∂)</b> ƒë·ªÉ nghe ho·∫∑c <b>T·∫£i Xu·ªëng</b>.", 'bg-yellow-100 text-yellow-800');
                    }


                } else {
                    showMessage("L·ªñI D·ªÆ LI·ªÜU: D·ªØ li·ªáu audio kh√¥ng h·ª£p l·ªá t·ª´ API.", 'bg-red-100 text-red-800');
                }
            } catch (e) {
                console.error("L·ªói x·ª≠ l√Ω ph·∫£n h·ªìi API:", e);
                showMessage("L·ªñI: X·∫£y ra s·ª± c·ªë khi x·ª≠ l√Ω d·ªØ li·ªáu √¢m thanh.", 'bg-red-100 text-red-800');
            }
        };

        // G·∫Øn s·ª± ki·ªán v√†o n√∫t
        generateButton.addEventListener('click', () => {
            generateTTS(textInput.value);
        });
        
        // G·∫Øn s·ª± ki·ªán cho n√∫t T·∫£i Xu·ªëng
        downloadButton.addEventListener('click', handleDownload);

    </script>
</body>
</html>
